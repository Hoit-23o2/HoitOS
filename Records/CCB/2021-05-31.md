# 2021-05-31

## 关于HoitFs当下面临的问题以及未来展望

### scalability

​		HoitFs不能仅把目光投放在2MB的Nor flash上，这个文件系统必须是可拓展到市面常用大小（64~128MB）的Nor flash上。要增强HoitFs的scalability，需要解决以下三个问题。

1. **扫描大容量设备过慢，挂载文件系统时间较长。**

   目前想到的解决方案是引入EBS（Erasable Block Summary）。即为每一块sector增设summary区域，记录本sector内部的数据实体信息。该区域起到了索引作用，减少扫描范围，从而加速扫描过程。[相关博客](https://blog.csdn.net/lh2016rocky/article/details/54693248)

2. **HoitFs占用内存空间过多。**

   HoitFs为每个Nor flash数据实体都创建一个raw info结构体（大约20B左右）。若单个数据实体内有效数据很少，那么HoitFs占用的内存空间几乎与Nor flash本身容量一样。目前想到的解决方案是采用cache的思想进行改进。原来HoitFs会为每一个数据实体创建raw info结构体。但根据局部性原理，只有较少的文件会被经常访问。因此，我们可以仅对部分文件的数据实体创建raw info结构体，这相当于采用一种文件cache。如果用户需要访问的文件没有在内存当中维护必要的数据结构，则为其创建这些数据结构。同时，采用特定算法（如LRU）进行文件cache的换入换出。这里相当于在内存空间和访问时间上做了一个tradeoff。这种做法还可以实现冷热数据（文件）分离。

3. **HoitFs对频繁的小数据写入极不友好。**

   HoitFs高层使用了红黑树来维护数据实体，这棵红黑树会为每一次写入操作创建一个叶子节点。所以我们可以想象如果分开写入512个“0“，那么这棵红黑树就会出现512个叶子节点！这一点是JFFS2架构固有的弊端。目前并没有什么有效的解决方案。暂时的想法是开文件写入数据cache，将要写入的小数据收集起来，统一写入Nor flash中。

### 其他改进

​	当前HoitFs同样有不尽人意的地方和可以优化的地方。以下是我们的设想和要解决的问题。

1. 采用多线程对Nor flash不同部分进行读写。

   我们设想在一个多核嵌入式设备上，若采用多线程分别读取Nor flash 的不同部分，则可能能够减少设备访问的时间，进一步提高IO速率。

2. 去除log

   JFFS2架构本身就有日志功能，再为其设置log就显得很多余。当初老师提出的，对Nor flash写入大数据中途掉电导致数据损坏的情况，我们可以简单地像处理小数据损失一样，将之前写入一半的数据直接抛弃。首先，我们有CRC校验码可以检测损坏的数据。其次，有可靠数据表名目前嵌入式设备主要写入小数据，写入长度为16KB以下的数据占所有写入长度的50%。

3. 使用多种列表管理erasable block

   HoitFs目前仍然采用单链表结构维护所有erasable block。可以使用多种链表来分别维护不同种类的block，例如clean_list，dirty_list核free_list等等。如此可加快erasable block的查询。

### 评估

​	目前，我们计划移植EXT2和SPIFFS到SylixOS上，与我们的HoitFs进行各项数据的评估。以验证我们的各项优化确实有效。